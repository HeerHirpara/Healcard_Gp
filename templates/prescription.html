{% extends "base.html" %}
{% block content %}

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background:#0e111a;">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center fw-bold text-info" href="/doctor/dashboard">
      <i class="fa-solid fa-user-doctor me-2"></i> MedStash Doctor
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#doctorNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="doctorNav">
      <ul class="navbar-nav text-center">
        <li class="nav-item mx-2"><a class="nav-link text-muted" href="/doctor/dashboard"><i class="fa-solid fa-gauge fa-lg"></i><br><small>Dashboard</small></a></li>
        <li class="nav-item mx-2"><a class="nav-link text-muted" href="/doctor/appointments"><i class="fa-solid fa-calendar-check fa-lg"></i><br><small>Appointments</small></a></li>
        <li class="nav-item mx-2"><a class="nav-link text-muted" href="/doctor/notifications"><i class="fa-solid fa-bell fa-lg"></i><br><small>Notifications</small></a></li>
        <li class="nav-item mx-2"><a class="nav-link text-muted" href="/wallet"><i class="fa-solid fa-wallet fa-lg"></i><br><small>Wallet</small></a></li>
        <li class="nav-item mx-2"><a class="nav-link text-muted" href="/doctor/profile"><i class="fa-solid fa-user fa-lg"></i><br><small>Profile</small></a></li>
        <li class="nav-item mx-2"><a class="nav-link text-muted" href="/logout"><i class="fa-solid fa-right-from-bracket fa-lg"></i><br><small>Logout</small></a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- ================= BACK BUTTON ================= -->
<div class="profile-back-btn">
  <a href="javascript:history.back()" title="Back">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
      <path d="M15 18l-6-6 6-6"
            stroke="#ffffff"
            stroke-width="2.4"
            stroke-linecap="round"
            stroke-linejoin="round"/>
    </svg>
  </a>
</div>


<div class="container-fluid mt-4 px-4">

  <!-- ================= HEADER ================= -->

  <div class="card pro-card mb-4 p-4">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h5 class="fw-semibold mb-1 text-info">
          <i class="fa-solid fa-prescription me-2"></i>Prescription Management
        </h5>
        <div class="small text-secondary">
          Patient: {{ appointment.patient_fname }} {{ appointment.patient_lname }}
        </div>
        <div class="small text-secondary">
          Date: {{ appointment.date }} | Time: {{ appointment.time }}
        </div>
      </div>
    </div>
  </div>


  <!-- ================= EXISTING PRESCRIPTIONS ================= -->

  {% if prescriptions %}
  <div class="card pro-card mb-4 p-4">

    <div class="section-title mb-3">
      <i class="fa-solid fa-clock-rotate-left me-2"></i>Existing Prescriptions
    </div>

    <div class="row g-3">

      {% for prescription in prescriptions %}

      <div class="col-lg-6">

        <div class="old-prescription">

          <div class="old-title">
            {{ prescription.medicine_name }}
          </div>

          <div class="old-grid">

            <div>
              <span>Tablets / Day</span>
              <strong>{{ prescription.tablets }}</strong>
            </div>

            <div>
              <span>Timing</span>
              <strong>{{ prescription.timing.title() }}</strong>
            </div>

            <div>
              <span>Before / After</span>
              <strong>{{ prescription.before_after_eat.title() }}</strong>
            </div>

            <div>
              <span>Duration</span>
              <strong>{{ prescription.duration or 'N/A' }} days</strong>
            </div>

          </div>

          <div class="old-date">
            Prescribed on {{ prescription.created_at }}
          </div>

        </div>

      </div>

      {% endfor %}

    </div>
  </div>
  {% endif %}


  <!-- ================= ADD PRESCRIPTION ================= -->

  <div class="card pro-card p-4">

    <div class="section-title mb-4">
      <i class="fa-solid fa-plus me-2"></i>Add New Prescription
    </div>

    <form id="prescriptionForm">

      <div id="medicinesContainer">

        <!-- row -->

        <div class="medicine-row mb-4">

          <div class="row g-3">

            <div class="col-lg-3 col-md-6">
              <label class="form-label">Medicine Name *</label>
              <input type="text" class="form-control medicine-name"
                     placeholder="Paracetamol"
                     list="medicineList"
                     required onchange="setDefaultPrice(this)"
                     onblur="checkMedicinePrice(this)">
            </div>

            <div class="col-lg-2 col-md-6">
              <label class="form-label">Tablets / Day *</label>
              <input type="number" class="form-control tablets"
                     min="1" max="10"
                     required onchange="calculateTotal(this)">
            </div>

            <div class="col-lg-2 col-md-6">
              <label class="form-label">Timing *</label>
              <select class="form-control timing" required>
                <option value="">Select</option>
                <option value="morning">Morning</option>
                <option value="night">Night</option>
                <option value="both">Morning & Night</option>
              </select>
            </div>

            <div class="col-lg-2 col-md-6">
              <label class="form-label">Before / After *</label>
              <select class="form-control before-after" required>
                <option value="">Select</option>
                <option value="before">Before Eat</option>
                <option value="after">After Eat</option>
              </select>
            </div>

            <div class="col-lg-1 col-md-4">
              <label class="form-label">Price ₹ *</label>
              <input type="number" class="form-control price"
                     min="0" step="0.01"
                     required onchange="calculateTotal(this)">
            </div>

            <div class="col-lg-1 col-md-4">
              <label class="form-label">Days *</label>
              <input type="number" class="form-control duration"
                     min="1" max="365"
                     required onchange="calculateTotal(this)">
            </div>

            <div class="col-lg-1 col-md-4">
              <label class="form-label">Total ₹</label>
              <input type="number" class="form-control total" readonly>
            </div>

            <div class="col-lg-1 col-md-12 d-flex align-items-end">
              <button type="button" class="btn btn-danger btn-sm remove-medicine" style="display:none;">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>

          </div>
        </div>

      </div>


      <!-- actions -->

      <div class="row mt-3">

        <div class="col-md-6 mb-2 mb-md-0">
          <button type="button" class="btn btn-success w-100" onclick="addMedicineRow()">
            <i class="fa-solid fa-plus me-2"></i>Add Another Medicine
          </button>
        </div>

        <div class="col-md-6">
          <button type="button" class="btn btn-info w-100" onclick="savePrescription()">
            <i class="fa-solid fa-floppy-disk me-2"></i>Save Prescription
          </button>
        </div>

      </div>

      <div id="saveStatus" class="mt-3 small" style="display:none;"></div>

    </form>

  </div>

</div>

<!-- Medicine Datalist -->
<datalist id="medicineList">
  <option value="Calpol">
  <option value="Paracetamol">
  <option value="Aspirin">
  <option value="Ibuprofen">
  <option value="Amoxicillin">
</datalist>

<!-- ================= STYLES ================= -->

<style>

body{
  background:#0b0f1a;
  color:#e6edf6;
}

/* back button */
.profile-back-btn{
  position:fixed;
  top:16px;
  left:16px;
  z-index:10;
}

.profile-back-btn a{
  width:44px;
  height:44px;
  border-radius:50%;
  background:#0b1220;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 6px 14px rgba(0,0,0,.45);
  transition:.2s;
}

.profile-back-btn a:hover{
  transform:translateX(-3px);
  background:#111a30;
}

/* main cards */

.pro-card{
  background:#121b2d;
  border:1px solid #22324a;
  border-radius:12px;
  box-shadow:none;
}

/* section titles */

.section-title{
  font-size:15px;
  font-weight:600;
  color:#9fdbea;
}

/* existing prescriptions */

.old-prescription{
  background:#0f172a;
  border:1px solid #22324a;
  border-radius:10px;
  padding:14px 16px;
}

.old-title{
  font-size:14px;
  font-weight:600;
  color:#eaf2ff;
  margin-bottom:10px;
}

.old-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  font-size:12.5px;
}

.old-grid span{
  display:block;
  color:#8fa3bf;
}

.old-grid strong{
  color:#e6edf6;
  font-weight:500;
}

.old-date{
  margin-top:10px;
  font-size:12px;
  color:#8fa3bf;
}

/* medicine row */

.medicine-row{
  background:#0f172a;
  border:1px solid #22324a;
  border-radius:10px;
  padding:16px;
}

/* form */

.form-label{
  font-size:12px;
  font-weight:600;
  color:#9fdbea;
}

.form-control{
  background:#0b1220;
  border:1px solid #1f2f46;
  color:#e6edf6;
  font-size:13px;
}

.form-control:focus{
  background:#0b1220;
  border-color:#4dd0e1;
  color:#e6edf6;
  box-shadow:none;
}

/* buttons */

.btn-success{
  background:#16a34a;
  border:none;
  font-weight:600;
}

.btn-success:hover{
  background:#22c55e;
}

.btn-info{
  background:#4dd0e1;
  color:#081018;
  border:none;
  font-weight:600;
}

.btn-info:hover{
  background:#26a69a;
  color:#081018;
}

.btn-outline-info{
  border-color:#4dd0e1;
  color:#4dd0e1;
}

.btn-outline-info:hover{
  background:#4dd0e1;
  color:#081018;
}

.btn-danger{
  background:#dc3545;
  border:none;
}

.text-secondary{
  color:#8fa3bf !important;
}

/* responsive */

@media(max-width:768px){

  .old-grid{
    grid-template-columns:1fr;
  }

}
/* -------- Pro dropdown -------- */

select.form-control{
  background-color:#0b1220;
  border:1px solid #1f2f46;
  color:#e6edf6;

  padding-right:12px;
  border-radius:10px;

  transition:all .25s ease;
}

/* hover */
select.form-control:hover{
  border-color:#4dd0e1;
}

/* focus */
select.form-control:focus{
  border-color:#4dd0e1;
  box-shadow:0 0 0 3px rgba(77,208,225,.18);
}

/* dropdown options (supported browsers only) */
select.form-control option{
  background:#0f172a;
  color:#e6edf6;
}

</style>


<!-- ================= SCRIPTS (UNCHANGED LOGIC) ================= -->

<script>

function addMedicineRow() {

    const container = document.getElementById('medicinesContainer');
    const newRow = document.createElement('div');
    newRow.className = 'medicine-row mb-4';

    newRow.innerHTML = `
      <div class="row g-3">

        <div class="col-lg-3 col-md-6">
          <label class="form-label">Medicine Name *</label>
          <input type="text" class="form-control medicine-name"
                 list="medicineList"
                 required onchange="setDefaultPrice(this)"
                 onblur="checkMedicinePrice(this)">
        </div>

        <div class="col-lg-2 col-md-6">
          <label class="form-label">Tablets / Day *</label>
          <input type="number" class="form-control tablets"
                 min="1" max="10"
                 required onchange="calculateTotal(this)">
        </div>

        <div class="col-lg-2 col-md-6">
          <label class="form-label">Timing *</label>
          <select class="form-control timing" required>
            <option value="">Select</option>
            <option value="morning">Morning</option>
            <option value="night">Night</option>
            <option value="both">Morning & Night</option>
          </select>
        </div>

        <div class="col-lg-2 col-md-6">
          <label class="form-label">Before / After *</label>
          <select class="form-control before-after" required>
            <option value="">Select</option>
            <option value="before">Before Eat</option>
            <option value="after">After Eat</option>
          </select>
        </div>

        <div class="col-lg-1 col-md-4">
          <label class="form-label">Price ₹ *</label>
          <input type="number" class="form-control price"
                 min="0" step="0.01"
                 required onchange="calculateTotal(this)">
        </div>

        <div class="col-lg-1 col-md-4">
          <label class="form-label">Days *</label>
          <input type="number" class="form-control duration"
                 min="1" max="365"
                 required onchange="calculateTotal(this)">
        </div>

        <div class="col-lg-1 col-md-4">
          <label class="form-label">Total ₹</label>
          <input type="number" class="form-control total" readonly>
        </div>

        <div class="col-lg-1 col-md-12 d-flex align-items-end">
          <button type="button" class="btn btn-danger btn-sm remove-medicine">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>

      </div>
    `;

    container.appendChild(newRow);
    updateRemoveButtons();
}


function updateRemoveButtons() {

    const rows = document.querySelectorAll('.medicine-row');

    rows.forEach((row) => {

        const removeBtn = row.querySelector('.remove-medicine');

        if (rows.length > 1) {
            removeBtn.style.display = 'block';
            removeBtn.onclick = () => {
                row.remove();
                updateRemoveButtons();
            };
        } else {
            removeBtn.style.display = 'none';
        }
    });
}


function savePrescription() {

    const medicines = [];
    const rows = document.querySelectorAll('.medicine-row');

    for (let row of rows) {

        const medicineName = row.querySelector('.medicine-name').value.trim();
        const tablets = row.querySelector('.tablets').value;
        const timing = row.querySelector('.timing').value;
        const beforeAfter = row.querySelector('.before-after').value;
        const price = row.querySelector('.price').value;
        const duration = row.querySelector('.duration').value;

        if (!medicineName || !tablets || !timing || !beforeAfter || !price || !duration) {
            showSaveStatus('Please fill all required fields (*) for each medicine', false);
            return;
        }

        medicines.push({
            medicine_name: medicineName,
            tablets: parseInt(tablets),
            timing: timing,
            before_after_eat: beforeAfter,
            price: parseFloat(price),
            duration: parseInt(duration)
        });
    }

    const saveBtn = document.querySelector('button[onclick="savePrescription()"]');
    const originalText = saveBtn.innerHTML;

    saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Saving...';
    saveBtn.disabled = true;

    fetch('/save_prescription/{{ appointment.id }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ medicines })
    })
    .then(res => res.json())
    .then(data => {

        if (data.success) {
            showSaveStatus('Prescription saved successfully!', true);
            setTimeout(() => window.location.reload(), 700);
        } else {
            showSaveStatus(data.message || 'Error saving prescription', false);
        }

    })
    .catch(() => showSaveStatus('Error saving prescription', false))
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function showSaveStatus(message, isSuccess) {
    const status = document.getElementById('saveStatus');
    status.textContent = message;
    status.style.display = 'block';
    status.style.color = isSuccess ? '#22c55e' : '#ff6b6b';
}


/* price mapping */

const medicinePrices = {
    'calpol': 30.00,
    'paracetamol': 25.00,
    'aspirin': 20.00,
    'ibuprofen': 35.00,
    'amoxicillin': 40.00
};


function setDefaultPrice(element) {

    const row = element.closest('.medicine-row');
    const medicineName = element.value.toLowerCase().trim();
    const priceInput = row.querySelector('.price');

    if (medicinePrices[medicineName]) {
        priceInput.value = medicinePrices[medicineName].toFixed(2);
        calculateTotal(priceInput);
    }
}

function checkMedicinePrice(element) {
    setDefaultPrice(element);
}


function calculateTotal(element) {

    const row = element.closest('.medicine-row');
    const tablets  = parseInt(row.querySelector('.tablets').value) || 0;
    const price    = parseFloat(row.querySelector('.price').value) || 0;
    const duration = parseInt(row.querySelector('.duration').value) || 0;

    row.querySelector('.total').value = (tablets * price * duration).toFixed(2);
}


document.addEventListener('DOMContentLoaded', updateRemoveButtons);

</script>

{% endblock %}
